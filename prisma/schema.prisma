// PDD (Russian driving theory) exam app — SQLite for MVP, Postgres-ready schema
// Switch provider to "postgresql" and set DATABASE_URL for production scaling.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ——— Core content ———

model Question {
  id         String   @id @default(cuid())
  externalId String   @unique // from JSON "id" (e.g. ffd0c95b28a89bd4faff45a8874c4fb3)
  text       String
  imageUrl   String?
  explanation String?
  createdAt  DateTime @default(now())

  options          Option[]
  answerLogs       AnswerLog[]
  topics           Topic[]           @relation("QuestionTopics")
  sessionQuestions SessionQuestion[]
}

model Option {
  id         String   @id @default(cuid())
  questionId String
  text       String
  isCorrect  Boolean

  question    Question   @relation(fields: [questionId], references: [id], onDelete: Cascade)
  answerLogs  AnswerLog[]

  @@index([questionId])
}

// Optional: topic from JSON "topic": ["Общие положения"]
model Topic {
  id   String @id @default(cuid())
  name String @unique

  questions Question[] @relation("QuestionTopics")
}

// ——— Theory (signs, markup, penalties) ———

model Sign {
  id          String   @id @default(cuid())
  code        String   @unique
  title       String
  description String
  imageUrl    String?
  category    String
  createdAt   DateTime @default(now())

  @@index([category])
}

model Markup {
  id          String   @id @default(cuid())
  code        String   @unique
  description String
  imageUrl    String?
  category    String
  createdAt   DateTime @default(now())

  @@index([category])
}

model Penalty {
  id          String   @id @default(cuid())
  articlePart String
  text        String
  penalty     String
  createdAt   DateTime @default(now())

  @@unique([articlePart, text])
  @@index([articlePart])
}

// ——— User progress / sessions ———

model Session {
  id            String    @id @default(cuid())
  mode          String    // "training" | "exam"
  startedAt     DateTime  @default(now())
  finishedAt    DateTime?
  score         Int?      // null until finished
  mistakesCount Int?      // null until finished
  durationSec   Int?      // for exam; 1200 = 20 min
  maxMistakes   Int?      // for exam; 2

  answerLogs       AnswerLog[]
  sessionQuestions SessionQuestion[]

  @@index([startedAt])
}

model SessionQuestion {
  id         String @id @default(cuid())
  sessionId  String
  questionId String
  orderIndex Int    // 0-based order in session

  session  Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, questionId])
  @@index([sessionId])
}

model AnswerLog {
  id               String   @id @default(cuid())
  questionId       String
  selectedOptionId String
  isCorrect        Boolean
  answeredAt       DateTime @default(now())
  sessionId        String

  question  Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  option    Option   @relation(fields: [selectedOptionId], references: [id], onDelete: Cascade)
  session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([questionId])
}
